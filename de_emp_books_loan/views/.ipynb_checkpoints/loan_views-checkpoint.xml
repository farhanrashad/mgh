<?xml version="1.0" encoding="UTF-8"?>
<odoo>
    <data>
        
        
        <!-- Loan view -->
        <record model="ir.ui.view" id="hr_employee_loan_tree_view">
            <field name="name">hr.employee.loan.tree.view</field>
            <field name="model">hr.employee.loan</field>
            <field name="arch" type="xml">
                <list string=" Loan">
                    <field name="name"/>
                    <field name="date"/>
                    <field name="ref"/>
                   <field name="employee_id"/>
                    <field name="loan_type_id"/>
                    <field name="amount"/>
                    <field name="currency_id" optional="hide"/>
                    <field name="date_start" optional="hide"/>
                    <field name="installments" optional="hide"/>
                    <field name="date_end" optional="hide"/>
                    <field name="company_id" groups="base.group_multi_company" optional="hide"/>
                    <field name="user_id" readonly="1" options="{'no_create':True}" string="Requested By" optional="hide"/>
                    <field name="state"/>
                </list>
            </field>
        </record>
        
        <record id="hr_employee_loan_form_view" model="ir.ui.view">
            <field name="name">hr.employee.loan.form.view</field>
            <field name="model">hr.employee.loan</field>
            <field name="arch" type="xml">
                <form string="Loan" class="o_advance_form">
                    <field name="can_reset" invisible="1"/>
                    <header> 
                        <button name="compute_loan"    invisible="state != 'draft'" string="Compute Loan" type="object" class="oe_highlight"/>
                        <button name="action_submit_request" invisible="state != 'validate'" string="Submit to Manager" type="object" class="oe_highlight"/>
                        <button name="approve_request"    invisible="state != 'submit'" string="Approve" type="object" groups="de_emp_books_loan.group_hr_loan_team_approver" class="oe_highlight"/>
                        
                        <button name="action_create_bill"
                            string="Post Journal Entries"
                            type="object"
                            class="oe_highlight o_expense_sheet_post"
                            invisible="state != 'approved'"
                            groups="account.group_account_invoice"/>
                        
                        
                        
                        <button name="reset_request" string="Reset to Draft" type="object"
                                invisible="can_reset == False or state not in ['cancel','submit','validate']" data-hotkey="q"/>
                        
                        <button name="%(de_emp_books_loan.hr_employee_loan_refuse_wizard_action)d"  invisible="state not in ['submit','approve']" context="{'hr_employee_loan_refuse_model':'hr.employee.loan'}" string="Refuse" type="action" groups="de_emp_books_loan.group_hr_loan_team_approver" />
                        <button name="%(de_emp_books_loan.hr_employee_loan_refund_wizard_action)d" invisible="state not in ['submit','approve','done'" context="{'hr_employee_loan_refund_model':'hr.employee.loan'}" string="Refund" type="action" groups="de_emp_books_loan.group_hr_loan_team_approver" />

                        
                        <field name="state" widget="statusbar" statusbar_visible="draft,validate,submit,approved,post,done"/>
                    </header>
                    <sheet>
                        <div class="oe_button_box" name="button_box">
                            <button type="object"
                        name="action_view_requests"
                        class="oe_stat_button"
                        icon="fa-truck"
                        invisible="deferred_request_count == 0" groups="de_emp_books_loan.group_hr_loan_user">
                        <field name="deferred_request_count" widget="statinfo" string="Deferred"/>
                    </button>
                            
                        </div>
                        <widget name="web_ribbon" title="Paid" bg_color="bg-success"
                                invisible="state != 'done'"/>
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"/>
                            <h1>
                                <field name="name" placeholder="e.g. Loan request for home"
                                       readonly="state != 'draft' "/>
                            </h1>
                        </div>
                        <group>
                            <group>
                                <field name="employee_id" required="1" options="{'no_create':True}" />
                                <field name="manager_id" readonly="1" options="{'no_create':True}" />
                                <field name="job_id" options="{'no_create':True}" />
                                <field name="department_id" />
                                <field name="loan_type_id" required="1" options="{'no_create':True}" />
                                                                
                                <label for="amount" string="Loan Amount"/>
                                <div class="o_row no-gutters d-flex">
                                    <div class="o_row">
                                        <field name="amount" class="text-left" />
                                    </div>
                                    <field name="currency_id" required="1" options="{'no_create':True}" />                         
                                </div>
                                <field name="interest_rate"/>
                                <field name="date_start"/>
                                <field name="installments"/>
                                <field name="date_end"/>
                            </group>
                            <group>
                                
                                <field name="date"/>
                                <field name="ref"/>
                                <field name="accounting_date"
                                       invisible="accounting_date == False or state not in ['approved', 'done']" />
                                
                                <field name="product_uom_category_id" invisible="1"/>
                                <field name="company_id" groups="base.group_multi_company"/>
                                <field name="user_id" readonly="1" options="{'no_create':True}" string="Requested By"/>
                            </group>
                        </group>
                        <div>
                            <field name="description" class="oe_inline" placeholder="Notes..."/>
                        </div>
                        <notebook>
                            <page name="loan_schedule" string="Loan Schedule">
                                <field name="loan_line" nolabel="1" >
                                    <list decoration-muted="state in ('close','cancel')" decoration-primary="state == 'submit'" decoration-info="state == 'approved'" decoration-success="state in ('post','done')" editable="bottom">

                                        <field name="date" optional="hide"/>
                                        <field name="date_end" optional="hide"/>
                                        <field name="date_due" />
                                        <field name="amount" string="Monthly Instalment" sum="Amount"/>
                                        <field name="amount_principal" string="Principal" />
                                        <field name="amount_interest" string="Interest" sum="Interest Balance"/>
                                        <field name="amount_total" string="Total" />
                                        <field name="amount_emi" string="EMI(Installment)" sum="EMI"/>
                                        
                                        <field name="currency_id" options="{'no_create':True}" optional="hide"/>
                                        <field name="state" />
                                    </list>
                                </field>
                                <group name="total_group" col="6" class="mt-2 mt-md-0">
                                    <group class="oe_subtotal_footer oe_right" colspan="2" name="loan_total">
                                        <field name="amount" widget='monetary' options="{'currency_field': 'currency_id'}"/>
                                        <field name="amount_refund" widget='monetary' options="{'currency_field': 'currency_id'}"/>
                                        <div class="oe_subtotal_footer_separator oe_inline o_td_label">
                                            <label for="amount_residual" />
                                        </div>
                                        <field name="amount_residual" nolabel="1" class="oe_subtotal_footer_separator" widget="monetary" options="{'currency_field': 'currency_id'}"/>

                                    </group>
                                    <div class="oe_clear"/>
                                </group>
                            </page>
                            <page name="loan_docs" string="Documents">
                                <field name="loan_doc_ids" nolabel="1" >
                                    <list editable="bottom">
                                        <field name="sequence" widget="handle" />
                                        <field name="name" placeholder="e.g Passport Copy" />
                                        <field name="loan_type_doc_id" invisible="1" />
                                        <field name="is_required" invisible="1"/>
                                        <field name="doc_file_id" required="is_required == True" />
                                    </list>
                                </field>
                            </page>
                            <page name="accounting_info" string="Accounting" groups="account.group_account_user,account.group_account_manager">
                                <group>
                                    <group>
                                        <field name="product_id" options="{'no_create_edit':True}"/>
                                        <field name="product_uom_id" />
                                        <field name="journal_id" options="{'no_create':True,'no_open':True}"/>
                                        <field name="account_move_id" />
                                        <field name="payment_state" invisible="1" />
                                    </group>
                                    <group>
                                        <field name="address_id" string="Partner"/>
                                    </group>
                                </group>
                            </page>
                        </notebook>
                    </sheet>
                    <div class="o_attachment_preview"/>
                    <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
                </form>
            </field>
        </record>
        
        <record id="action_hr_employee_loan" model="ir.actions.act_window">
            <field name="name">Loan Request</field>
            <field name="res_model">hr.employee.loan</field>
            <field name="view_mode">list,kanban,form,graph,pivot</field>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    No loan request found. Let's create one!
                </p><p>
                    Employee requests for loan.  
                </p>
            </field>
        </record>
        
        <menuitem id="menu_emp_books_loan_request" action="action_hr_employee_loan" parent="menu_emp_books_loan" name="Loan Request" sequence="1" groups="hr.group_hr_manager"/>   
        
        
        
        <record id="action_hr_employee_loan_disbursed" model="ir.actions.act_window">
            <field name="name">Loan Disbursed</field>
            <field name="res_model">hr.employee.loan</field>
            <field name="view_mode">list,kanban,form,graph,pivot</field>
            <field name="domain">[('state', '=', 'done')]</field>
        </record>
        
        <menuitem id="menu_emp_books_loan_disbursement" action="action_hr_employee_loan_disbursed" parent="menu_emp_books_loan" name="Disbursements" sequence="20" groups="hr.group_hr_manager"/>  
        
        <!-- Installments -->
        <record model="ir.ui.view" id="hr_employee_loan_line_tree_view">
            <field name="name">hr.employee.loan.line.tree.view</field>
            <field name="model">hr.employee.loan.line</field>
            <field name="arch" type="xml">
                <list string="Loan Line">
                    <field name="name" optional="hide"/>
                    <field name="employee_loan_id" optional="hide"/>
                    <field name="employee_id"/>
                    <field name="date"/>
                    <field name="date_end" optional="hide"/>
                    <field name="date_due"/>
                    <field name="amount" />
                    <field name="amount_principal" optional="hide"/>
                    <field name="amount_interest" />
                    <field name="amount_emi" />
                    <field name="amount_total" optional="hide"/>
                    <field name="state"/>
                </list>
            </field>
        </record>
        
        <record id="hr_employee_loan_line_form_view" model="ir.ui.view">
            <field name="name">hr.employee.loan.line.form.view</field>
            <field name="model">hr.employee.loan.line</field>
            <field name="arch" type="xml">
                <form string="Loan" class="o_advance_form">
                    <header>
                        <field name="state" widget="statusbar" statusbar_visible="draft,validate,submit,approved,post,done"/>
                    </header>
                    <sheet>
                        <div class="oe_title">
                            <label for="name" class="oe_edit_only"/>
                            <h1>
                                <field name="name" placeholder="e.g. Loan request for home"
                                       readonly="state !='draft'"/>
                            </h1>
                        </div>
                        <group>
                            <group>
                                <field name="employee_loan_id" options="{'no_edit_create':True}"/>
                                <field name="employee_id" />
                                <field name="date" />
                                <field name="date_end" />
                                <field name="date_due" />
                            </group>
                            <group>
                                <field name="currency_id" options="{'no_edit_create':True}"/>
                                <field name="amount" />
                                <field name="amount_principal" />
                                <field name="amount_interest" />
                                <field name="amount_emi" />
                                <field name="amount_total" />
                            </group>
                        </group>
                    </sheet>
                </form>
            </field>
        </record>
        
       <record id="view_employee_loan_installment_filter" model="ir.ui.view">
            <field name="name">hr.employee.loan.line.filter</field>
            <field name="model">hr.employee.loan.line</field>
            <field name="priority" eval="15"/>
            <field name="arch" type="xml">
                <search string="Search Loan Installments">
                    <field name="employee_id" operator="child_of"/>
                    <group expand="0" string="Group By">
                        <filter name="employee" string="Employee" domain="[]" context="{'group_by': 'employee_id'}"/>
                    </group>
               </search>
            </field>
        </record>
        
        <record id="action_hr_employee_loan_installment" model="ir.actions.act_window">
            <field name="name">Loan Installments</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">hr.employee.loan.line</field>
            <field name="view_mode">list,form</field>
            <field name="search_view_id" ref="view_employee_loan_installment_filter"/>
            <field name="help" type="html">
                <p class="o_view_nocontent_smiling_face">
                    Create a new installment!
                </p>
            </field>
        </record>

        <record id="employee_loan_installment_tree_view" model="ir.actions.act_window.view">
            <field name="sequence" eval="1"/>
            <field name="view_mode">list</field>
            <field name="view_id" ref="hr_employee_loan_line_tree_view"/>
            <field name="act_window_id" ref="action_hr_employee_loan_installment"/>
        </record>
        
        
        <menuitem id="action_hr_employee_loan_installment" action="action_hr_employee_loan_installment" parent="menu_emp_books_loan" name="Installments" sequence="30" groups="hr.group_hr_manager"/>  
        

        
    </data>
</odoo>